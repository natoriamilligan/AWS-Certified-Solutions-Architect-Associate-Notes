# Load Balancers
## Scalability
  
  ### Vertical Scalability
  - increasing the size of an instance

  ### Horizontal Scalability (scale out or scale in)
  - increasing the number of instances
  - implies you have distributed systems

  ## Availability

  ### High Availability
  - usually goes hand in hand with horizontal scaling
  - running your app/instances for the same app in at least 2 data centers or two AZs
  - goal is to survive data loss
  - can be passive or active

  ## Load Balacing (Elastic Load Balancer)
  - servers that forward traffic to multiple servers (instances) downstream
  - the more users you have the more the load is going to be balacned accross instances but your users dont know what instances they are using.
  - expose a single point of access for your app (DNS)
  - handles dailures of downstream instances
  - can do health checks on instances
    - the ELB can provide the checks on the instance. If the instance isnt working, no traffic will be sent to it
  - provides ssl termination for your website
  - high avalabilty accros zones
  - separate public and private traffic
  - AWS guaratees that it will be working
  - AWs provides only a few configuration knobs
  - costs less than managing your own load balancer
  - ELB is intergrated with so many services in AWS
    ### Security Groups with ELB
    - users can access the balancer from anywhere
    - The EC2 instances only allow traffic from the ELB (security group to security group to connect)

    ### Types of Load Balancers
      - best to use new generations
      - can setup internal or external ELBs
      #### Application Load Balancer (v2 new gen 2016 ALB)
      - Layer 7 (HTTP)
      - load balancing to multiple HTTP apps accross machines
      - load balancig to mupliple apps on the same machine (containers)
      - support for HTTP/2 and WebSocket
      - Supports redirects (HTTP to HTTPs for exmaple)
      - load balancer gets a fixed hostname (URL)
      - app servers dont see the IP of the client directly which means the instances through the balancer can see the client who sent the load directly. They have to look at extra headers in the request. This is through listeners and rules
        - the true IP of the client is inserted in the header called X-Forward-For
        - we can also get the port with the header > (X-Forward-port) and protocol used with the header > (X-forwarded-proto)
      - Routing tables to different target groups
        - routing based on path in URL (you can redirect these paths to different target groups)
        - routing based on hostname in URL
        - routing based on Query String, Headers
        - A great fit for micro services and container based apps (Docker and Amazon ECS)
        - has port mapping feature to redirect to a dynamic port in ECS
        - in comparison we would need multiple classic load balancers per app
      **What are target groups?**
        TYPES
        - EC2 instances (managed by Auto Scaling Group) - HTTP
        - ECs tasks (managed by ECS itself) - HTTP
        - lambda functions - HTTP request is translated ina JSOM format
        - IP addresses - must be private IPs
        ********
        - ALB can route to multiple target groups
        - health checks are at the target group level
  
       
      #### Network Load Balancer (v2 new gen 2017 NLB)
      - Layer 4 : TCP and UDP traffic
      - handle millions fo requests per seconds
      - ultra-low latency
      - has one static IP per ZA and supprots assigning Elastic IP
      - used for extreme performance, TCP or UDP, static IPs
        Target Groups
      - EC2 instances
      - IP addresses - must be private
      - can have a network load balancer in front of an ALB
      - heath checks support the TCP , HTTP and HTTPS protocols
        
      #### Gateway Load Balancer (2020 GWLB)
      - Layer 3 (lowest level) (network Layer)
        - IP packets
      - use GENEVE protocol 6081
      - used to deploy, scale and manage a fleet of network virtual apps in AWS
      - used if you want all traffic to go through a firewall or something else (wanting the traffic to be inspected)
      - the traffic will go through the GWLB then the GWLB spreads the traffic to 3rd party virutal appliances. If they are happy the GWLB then sends the traffic to the app/instances
        Target Groups
        - EC2 instances
        - IPs : Ips must be private
          
    ### Sticky Sessions (Session Affinity)
    - same client is always redirected to the same instance behind the load balancer
    - works for all the LBs except GWLB
    - the "cookie" used to stickiness has a expiration date you control
    - use case : make sure the user doesnt lose his session data
    - may bring imbalance to the load
      #### Cookie Names
      - Application-based Cookies
        - custom cookie
          - generated by the target
          - can include custom attributes required by the app
          - cookie name must be specified individually for each target group
          - dont use AWSALB, AWSALBAPP or AWDALBTG (reserved by the ELB)
        - Application Cookie
          - generated by the load balancer
          - cookie name is AWSALBAPP
         
      - Duration-based Cookies
        - cookie generated by the load balancer
        - cookie name is AWSALB for ALB, AWSELB for CLB
        - 
  ## Cross-Zone Load Balancing
  - found in the attributes section of the load balancers
  - each LB will distributes evenly accross all registers instances in all AZs
  - no matter how many instances are in each AZ, all the clients will be evenly distributed
  - by default the load balancers will distribute evenly and then distribute even more if cross load balancing is not enabled
    ### ALB
    - enabled by default (can disable at the target group level)
    - no charges if data goes accross AZs since its by default
    ### NLB and GWLB
    - disabled by default
    - you pay charges for inter AZ
   
  ## SSL/TLS Basics
  - SSl certificate allows traffc btw cliuents and load balancer to be encrypted in transit.
  - SSL ( Secure Socket Layer ) : used to encrypt connections
  - TLS ( Transport Layer Security ) : newer version and more commonly used
  - Public SSL certs are issued by Certificate Authority (CA)
  - have an expiration date you set and must be renewed
    ## Load Balancers and SSL/TLS Certs
    - load balancer uses an X.509 cert
    - you can manage certs using ACM (AWS Certificate Manager)
    - you can upload your own certs
    - when you specify an HTTPS listener:
      - you must specify a default cert
      - you can add an optional list of certs to support multiple domains
      - clients can use SNI (Server Name Indication) to specify the hostmane they reach
        - SNI
          - ability to load multiple SSL certs onto one web server ( to serve multiple websites)
          - is a newer protocol that requires the client to indicate the hostname of the target server in the initial SSL handshake
          - the server will find the correct cert or return the default one
      - ability to specify a security policy to support older versions of SSL/TLS (legacy clients)
      - only works with ALB or NLB or cloudfront not CLB
      ********
      - CLB only suports 1 SSL cert
        - must use multiple CLB for multiple hostname with multiple SSL certs
      - ALB
        - supports multiple listeners with multiple SSL certs
        - Uses SNI to make it work
      - NLB
        - upports multiple listeners with multiple SSL certs
        - Uses SNI to make it work

    ## Connection Draining
     - Feature Naming
       - Connection Draining (CLB)
       - Degregistration Delay (ALB and NLB)
    - time to complete in flight requests while the instance is derigistering or unhealty
    - stops sending new requests to the EC2 instance while is deregistering
    - the load balancer is smart enough to route requests to other instances that arent draiing
    - between 1 to 3600 seconds (default 300 seconds) or disable( value to 0)
    - set your value low if your requests are short
   
  ## Auto Scaling Group (AGS)
  - free
  - used to scale out to match an increaded load and vise versa
  - ensure we have a minimun and max number of instances running
  - automatically register new instaces to a load balancer
  - re-create an instance in case a previous one is terminated (unhealthy)
  - it is possbile to scale in/out based on CloudWatch alarms
    - an alarm monitors metrics (avg CPU, requestCountperTarget, avg network in/out, or custom metric)
  **How to create an ASG?**
    - a Launch Template
      - contains info on how to launch the instances within the ASG
    - min size/max size, initial capacity
    - Scaling policy
      - Dynamic Scaling
        - Target Tracking Scaling
          - simple to set up
          - set up a metric
        - Simple / Step Scaling
          - when a CloudWatch alarm is triggered then do something (either steps or a simple action)
      - Scheduled Scaling
        - anticipate a scaling based on know usage patterns
      - Predictive Scaling
        - continuously forecast load and schedule scaling ahead
            - analyze historical load > generate forecast > schedule scaling actions
    - Scaling Cooldowns
      - after a scaling activty happens you are in a cooldown period
      - the ASG will not launch or terminate additionals instances to allow metrics to stabilize
      - ADVICE : use a ready to use AMi to reduce configuration time in order to be serving request faster and reduce the cooldown period


















    
